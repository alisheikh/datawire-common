#!/usr/bin/env python

import sys, time
from argparse import ArgumentParser
from proton.reactor import Reactor
from datawire import Address, Tether, Processor

class Service:

    def __init__(self, args):
        self.tether = Tether(args.directory, args.address, args.physical)
        self.physical = Address.parse(args.physical)

    def on_reactor_init(self, event):
        event.reactor.acceptor(self.physical.host, self.physical.port, Processor(self))
        self.tether.start(event.reactor)

    def on_message(self, event):
        print event.message

parser = ArgumentParser(prog="recv")
parser.add_argument("-d", "--directory", default="//localhost/directory", help="datawire directory")
parser.add_argument("-p", "--physical", default="//localhost:5678", help="physical address")
parser.add_argument("address", help="amqp address")

Reactor(Service(parser.parse_args())).run()
